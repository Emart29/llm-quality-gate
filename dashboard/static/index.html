<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLMQ Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand:  { DEFAULT: '#6366f1', light: '#818cf8', dark: '#4f46e5' },
            surface: { 1: '#0f172a', 2: '#1e293b', 3: '#334155' },
          }
        }
      }
    }
  </script>
</head>
<body class="bg-surface-1 text-gray-200 min-h-screen">
  <nav class="bg-surface-2 border-b border-surface-3 px-4 sm:px-6 py-3 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-brand flex items-center justify-center font-bold text-white">Q</div>
        <h1 class="text-lg font-semibold">LLMQ Dashboard</h1>
      </div>
      <div id="toast" class="hidden text-xs px-3 py-1 rounded bg-surface-3 border border-surface-3"></div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 bg-surface-2 border border-surface-3 rounded-xl p-4">
        <h2 class="font-semibold mb-3">Provider & Model Management</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <label class="text-sm">Generator Provider
            <select id="generator-provider" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-3 py-2"></select>
          </label>
          <label class="text-sm">Generator Model
            <input id="generator-model" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-3 py-2" />
          </label>
          <label class="text-sm">Judge Provider
            <select id="judge-provider" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-3 py-2"></select>
          </label>
          <label class="text-sm">Judge Model
            <input id="judge-model" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-3 py-2" />
          </label>
        </div>
        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
          <label class="text-xs">Task Success
            <input id="th-task" type="number" min="0" max="1" step="0.01" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-2 py-1.5" />
          </label>
          <label class="text-xs">Relevance
            <input id="th-rel" type="number" min="0" max="1" step="0.01" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-2 py-1.5" />
          </label>
          <label class="text-xs">Hallucination
            <input id="th-hal" type="number" min="0" max="1" step="0.01" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-2 py-1.5" />
          </label>
          <label class="text-xs">Consistency
            <input id="th-cons" type="number" min="0" max="1" step="0.01" class="mt-1 w-full bg-surface-3 border border-surface-3 rounded px-2 py-1.5" />
          </label>
        </div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button onclick="saveSettings()" class="bg-brand hover:bg-brand-dark text-white px-4 py-2 rounded text-sm">Save Settings</button>
          <button onclick="startEvaluation()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded text-sm">Start Evaluation</button>
        </div>
      </div>

      <div class="bg-surface-2 border border-surface-3 rounded-xl p-4">
        <h2 class="font-semibold mb-3">Live Evaluations</h2>
        <div id="live-jobs" class="space-y-2 text-sm"></div>
      </div>
    </section>

    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><p class="text-xs text-gray-400">Task Success</p><p id="kpi-task" class="text-2xl font-bold text-emerald-400">--</p></div>
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><p class="text-xs text-gray-400">Relevance</p><p id="kpi-rel" class="text-2xl font-bold text-blue-400">--</p></div>
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><p class="text-xs text-gray-400">Hallucination</p><p id="kpi-hal" class="text-2xl font-bold text-red-400">--</p></div>
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><p class="text-xs text-gray-400">Gate Pass Rate</p><p id="kpi-gate" class="text-2xl font-bold text-brand-light">--</p></div>
    </section>

    <section class="grid xl:grid-cols-2 gap-4">
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><h3 class="text-sm font-semibold mb-3">Metrics Over Time</h3><canvas id="chart-trends" height="220"></canvas></div>
      <div class="bg-surface-2 rounded-xl p-4 border border-surface-3"><h3 class="text-sm font-semibold mb-3">Side-by-Side Provider Comparison</h3><canvas id="chart-compare" height="220"></canvas></div>
    </section>

    <section class="bg-surface-2 rounded-xl p-4 border border-surface-3">
      <h2 class="font-semibold mb-3">Historical Run Search</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-4 text-sm">
        <select id="filter-provider" class="bg-surface-3 border border-surface-3 rounded px-3 py-2"><option value="">All Providers</option></select>
        <select id="filter-model" class="bg-surface-3 border border-surface-3 rounded px-3 py-2"><option value="">All Models</option></select>
        <select id="filter-dataset" class="bg-surface-3 border border-surface-3 rounded px-3 py-2"><option value="">All Dataset Versions</option></select>
        <select id="filter-status" class="bg-surface-3 border border-surface-3 rounded px-3 py-2"><option value="">Pass / Fail</option><option value="true">PASS</option><option value="false">FAIL</option></select>
        <select id="filter-commit" class="bg-surface-3 border border-surface-3 rounded px-3 py-2"><option value="">All Commits</option></select>
      </div>
      <button onclick="loadRuns()" class="mb-3 bg-brand hover:bg-brand-dark text-white px-3 py-1.5 rounded text-sm">Apply Filters</button>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr class="text-gray-400 border-b border-surface-3"><th class="text-left py-2 px-2">Provider/Model</th><th class="text-left py-2 px-2">Dataset</th><th class="text-left py-2 px-2">Commit</th><th class="text-center py-2 px-2">Overall</th><th class="text-center py-2 px-2">Gate</th><th class="text-center py-2 px-2">Regression</th><th class="text-left py-2 px-2">Date</th></tr></thead>
          <tbody id="runs-body"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-surface-2 rounded-xl p-4 border border-surface-3">
      <h2 class="font-semibold mb-3">Per-test Case Drill-down</h2>
      <div id="drilldown" class="space-y-3"></div>
    </section>
  </main>

<script>
let trendsChart, compareChart;
let poller;

function notify(message, level='info') {
  const toast = document.getElementById('toast');
  toast.className = `text-xs px-3 py-1 rounded border ${level==='pass' ? 'bg-emerald-900 text-emerald-200 border-emerald-700' : level==='fail' ? 'bg-red-900 text-red-200 border-red-700' : 'bg-surface-3 border-surface-3'}`;
  toast.textContent = message;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 3000);
}

async function loadSettings() {
  const [providersRes, settingsRes] = await Promise.all([fetch('/api/v1/providers'), fetch('/api/v1/settings')]);
  const providersData = await providersRes.json();
  const settings = await settingsRes.json();

  const providerNames = (providersData.providers || []).map(p => p.name);
  const providerOptions = providerNames.map(p => `<option value="${p}">${p}</option>`).join('');
  document.getElementById('generator-provider').innerHTML = providerOptions;
  document.getElementById('judge-provider').innerHTML = providerOptions;

  document.getElementById('generator-provider').value = settings.roles?.generator?.provider || providerNames[0] || '';
  document.getElementById('judge-provider').value = settings.roles?.judge?.provider || providerNames[0] || '';
  document.getElementById('generator-model').value = settings.roles?.generator?.model || '';
  document.getElementById('judge-model').value = settings.roles?.judge?.model || '';
  document.getElementById('th-task').value = settings.quality_gates?.task_success_threshold ?? 0.8;
  document.getElementById('th-rel').value = settings.quality_gates?.relevance_threshold ?? 0.7;
  document.getElementById('th-hal').value = settings.quality_gates?.hallucination_threshold ?? 0.1;
  document.getElementById('th-cons').value = settings.quality_gates?.consistency_threshold ?? 0.8;
}

async function saveSettings() {
  const payload = {
    roles: {
      generator: { provider: value('generator-provider'), model: value('generator-model') },
      judge: { provider: value('judge-provider'), model: value('judge-model') },
    },
    quality_gates: {
      task_success_threshold: num('th-task'),
      relevance_threshold: num('th-rel'),
      hallucination_threshold: num('th-hal'),
      consistency_threshold: num('th-cons'),
    },
  };
  await fetch('/api/v1/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
  notify('Settings saved.');
}

async function startEvaluation() {
  const payload = { provider: value('generator-provider'), model: value('generator-model') };
  const res = await fetch('/api/v1/evaluate/start', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  if (data.job_id) notify(`Evaluation started: ${data.job_id.slice(0,8)}`);
  await loadLiveJobs();
}

async function loadLiveJobs() {
  const res = await fetch('/api/v1/evaluate/active');
  const data = await res.json();
  const jobs = data.jobs || [];
  const div = document.getElementById('live-jobs');
  if (!jobs.length) {
    div.innerHTML = '<p class="text-gray-400">No active runs.</p>';
    return;
  }
  div.innerHTML = jobs.map(j => {
    const pct = j.total ? Math.round((j.progress / j.total) * 100) : 0;
    return `<div class="bg-surface-3 rounded p-3"><p class="font-medium">${j.provider}/${j.model || '-'}</p><p class="text-xs text-gray-400 mb-2">${j.job_id.slice(0,8)} • ${j.progress}/${j.total}</p><div class="h-2 bg-surface-2 rounded overflow-hidden"><div class="h-full bg-brand" style="width:${pct}%"></div></div></div>`;
  }).join('');
}

async function loadOverview() {
  const res = await fetch('/api/overview');
  const data = await res.json();
  text('kpi-task', pct(data.avg_task_success));
  text('kpi-rel', pct(data.avg_relevance));
  text('kpi-hal', pct(data.avg_hallucination));
  text('kpi-gate', pct(data.quality_gate_pass_rate, 0));
  renderCharts(data.recent_runs || []);
}

function renderCharts(runs) {
  const labels = runs.map((_, i) => `Run ${i + 1}`).reverse();
  const overall = runs.map(r => (r.overall_score || 0) * 100).reverse();
  const task = runs.map(r => (r.task_success_score || 0) * 100).reverse();
  if (trendsChart) trendsChart.destroy();
  trendsChart = new Chart(document.getElementById('chart-trends'), {
    type: 'line',
    data: { labels, datasets: [
      { label: 'Overall', data: overall, borderColor: '#818cf8', tension: .3 },
      { label: 'Task', data: task, borderColor: '#34d399', tension: .3 },
    ]},
    options: chartOpts()
  });

  const grouped = {};
  runs.forEach(r => {
    const key = `${r.provider_name}/${r.model_name}`;
    grouped[key] = grouped[key] || [];
    grouped[key].push(r.overall_score || 0);
  });
  const compareLabels = Object.keys(grouped);
  const compareData = compareLabels.map(k => grouped[k].reduce((a,b)=>a+b,0)/grouped[k].length*100);
  if (compareChart) compareChart.destroy();
  compareChart = new Chart(document.getElementById('chart-compare'), {
    type: 'bar',
    data: { labels: compareLabels, datasets: [{label:'Avg Overall', data: compareData, backgroundColor:'#60a5fa'}]},
    options: chartOpts()
  });
}

async function loadFilters() {
  const [v1Res, legacyRes] = await Promise.all([fetch('/api/v1/runs/filters'), fetch('/api/run-filters')]);
  const data = v1Res.ok ? await v1Res.json() : await legacyRes.json();
  hydrateSelect('filter-provider', data.providers || []);
  hydrateSelect('filter-model', data.models || []);
  hydrateSelect('filter-dataset', data.dataset_versions || []);
  hydrateSelect('filter-commit', data.commit_hashes || []);
}

async function loadRuns() {
  const params = new URLSearchParams({ limit: '80' });
  if (value('filter-provider')) params.set('provider', value('filter-provider'));
  if (value('filter-model')) params.set('model', value('filter-model'));
  if (value('filter-dataset')) params.set('dataset_version', value('filter-dataset'));
  if (value('filter-status')) params.set('quality_gate_passed', value('filter-status'));
  if (value('filter-commit')) params.set('commit_hash', value('filter-commit'));

  const res = await fetch(`/api/v1/runs?${params.toString()}`);
  const data = await res.json();
  const runs = data.runs || [];
  const tbody = document.getElementById('runs-body');
  tbody.innerHTML = runs.map((r, idx) => {
    const prev = runs.slice(idx + 1).find(x => x.provider_name === r.provider_name && x.model_name === r.model_name);
    const delta = prev ? ((r.overall_score || 0) - (prev.overall_score || 0)) : null;
    const regression = delta !== null && delta < -0.03;
    return `<tr class="border-b border-surface-3 hover:bg-surface-3/50 cursor-pointer" onclick="loadRunDetails('${r.id}')">
      <td class="py-2 px-2">${r.provider_name}/${r.model_name}</td>
      <td class="py-2 px-2 text-gray-400">${r.dataset_version || '-'}</td>
      <td class="py-2 px-2 font-mono text-xs text-gray-400">${(r.commit_hash || '-').slice(0,8)}</td>
      <td class="py-2 px-2 text-center">${pct(r.overall_score)}</td>
      <td class="py-2 px-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${r.quality_gate_passed ? 'bg-emerald-900 text-emerald-300' : 'bg-red-900 text-red-300'}">${r.quality_gate_passed ? 'PASS' : 'FAIL'}</span></td>
      <td class="py-2 px-2 text-center">${delta === null ? '-' : `<span class="${regression ? 'text-red-400' : 'text-emerald-400'}">${(delta * 100).toFixed(1)}%</span>`}${regression ? ' ⚠️' : ''}</td>
      <td class="py-2 px-2 text-xs text-gray-400">${new Date(r.created_at).toLocaleString()}</td>
    </tr>`;
  }).join('');

  const latest = runs[0];
  if (latest?.quality_gate_passed === true) notify(`Run ${latest.id.slice(0,8)} passed quality gate`, 'pass');
  if (latest?.quality_gate_passed === false) notify(`Run ${latest.id.slice(0,8)} failed quality gate`, 'fail');
}

async function loadRunDetails(runId) {
  const res = await fetch(`/api/runs/${runId}`);
  const data = await res.json();
  const rows = (data.test_cases || []).slice(0, 12);
  const container = document.getElementById('drilldown');
  container.innerHTML = rows.map((tc, idx) => `
    <details class="bg-surface-3 rounded p-3" ${idx === 0 ? 'open' : ''}>
      <summary class="cursor-pointer text-sm"><span class="font-mono text-xs mr-2">${tc.test_case_id}</span> ${tc.success ? '✅' : '❌'} ${tc.task_type || ''}</summary>
      <div class="mt-2 text-xs text-gray-300 space-y-1">
        <p><span class="text-gray-400">Prompt:</span> ${escapeHtml(tc.input_prompt || '')}</p>
        <p><span class="text-gray-400">Output:</span> ${escapeHtml(tc.generated_output || '')}</p>
        <p><span class="text-gray-400">Task/Relevance/Hallucination:</span> ${pct(tc.task_success_score)} / ${pct(tc.relevance_score)} / ${pct(tc.hallucination_score)}</p>
      </div>
    </details>
  `).join('') || '<p class="text-gray-400">No test case details available.</p>';
}

function chartOpts() {
  return {
    responsive: true,
    plugins: { legend: { labels: { color: '#94a3b8' } } },
    scales: {
      x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
      y: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' }, min: 0, max: 100 },
    }
  };
}

function hydrateSelect(id, values) {
  const el = document.getElementById(id);
  const first = el.querySelector('option').outerHTML;
  el.innerHTML = first + values.map(v => `<option value="${v}">${v}</option>`).join('');
}
function value(id) { return document.getElementById(id).value; }
function num(id) { return Number(document.getElementById(id).value); }
function text(id, v) { document.getElementById(id).textContent = v; }
function pct(v, d=1) { return `${((v || 0) * 100).toFixed(d)}%`; }
function escapeHtml(input) { return String(input).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function boot() {
  await Promise.all([loadSettings(), loadOverview(), loadFilters(), loadRuns(), loadLiveJobs()]);
  poller = setInterval(async () => {
    await loadLiveJobs();
    await loadOverview();
    await loadRuns();
  }, 8000);
}
boot();
</script>
</body>
</html>
